{% extends 'matistikk/base.html' %}
{% load staticfiles %}
{% load static %}
{% block head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/i18n/jquery-ui-i18n.min.js"></script>

    <script type="text/javascript" src="{% static 'maths/js/bootstrap-clockpicker.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'maths/css/bootstrap-clockpicker.min.css' %}" type="text/css"/>
{% endblock %}
{% block body %}
    <div class="panel panel-info">
        <div class="panel-heading">
            <h2>{{ test.task_collection.test_name }} - {{ test.id }}</h2>
            <h5><strong>Publisert:</strong> {{ test.published }}</h5>
            <h5 id="id_dueDate"><strong>Frist for besvarelse:</strong>
                {% if test.dueDate %}{{ test.dueDate }}{% else %}Ingen{% endif %}
            </h5>
            <h5><strong>Tilfeldig rekkefølge:</strong> {% if test.randomOrder %}Ja{% else %}Nei{% endif %}</h5>
        </div>
        <div class="panel-body">
            <ul class="nav nav-tabs">
                {% if test.person_set %}
                    <li class="nav active"><a href="#A" data-toggle="tab">Elever</a></li>{% endif %}
                {% if grades %}
                    <li class="nav"><a href="#C" data-toggle="tab">Klasser</a></li>{% endif %}
                {% if groups %}
                    <li class="nav"><a href="#D" data-toggle="tab">Grupper</a></li>{% endif %}
                <li class="nav"><a href="#E" data-toggle="tab">Oppgaver</a></li>
            </ul>
            <div class="tab-content">
                {% if students %}
                    <div class="tab-pane fade in active" id="A">
                        <table class="table table-hover table-striped table-responsive" id="studenttable">
                            <thead>
                            <tr>
                                <th>Fornavn</th>
                                <th>Etternavn</th>
                                <th>Brukernavn</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for student in students %}
                                <tr id="user{{ student.id }}">
                                    <td>{{ student.first_name }}</td>
                                    <td>{{ student.last_name }}</td>
                                    <td>{{ student.username }}</td>
                                    <td>
                                        <button disabled='disabled' id="{{ student.username }}"
                                                value="{{ student.username }}"
                                                class='btn btn-default'>
                                            <i class="fa fa-check-circle" aria-hidden="true"></i>
                                            Besvarelse
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% if grades %}
                    <div class="tab-pane fade" id="C">
                        <div id="menu" style="padding-top: 10px">
                            <div class="panel list-group">
                                {% for grade in grades %}
                                    <a class="list-group-item" data-toggle="collapse" style="cursor: pointer"
                                       data-target="#grade{{ grade.id }}"
                                       data-parent="#menu">{{ grade }} <span
                                            class="label label-info">6</span>
                                        <span class="label label-success">3</span>
                                        <span class="label label-danger">3</span>
                                        <span class="glyphicon glyphicon-education pull-right"></span></a>
                                    <div id="grade{{ grade.id }}" class="sublinks collapse">
                                        {% for student in grade.person_set.all %}
                                            {% if  student.role == 1 %}
                                                <a class="list-group-item small"
                                                   style="padding-left: 50px; cursor: pointer;"><span
                                                        class="glyphicon glyphicon-user"></span>
                                                    {{ student }}
                                                </a>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if groups %}
                    <div class="tab-pane fade" id="D">
                        <div id="menu" style="padding-top: 10px">
                            <div class="panel list-group">
                                {% for group in groups %}
                                    <a class="list-group-item" data-toggle="collapse" style="cursor: pointer"
                                       data-target="#group{{ group.id }}"
                                       data-parent="#menu">{{ group }} <span
                                            class="label label-info"></span>
                                        <span class="label label-success"></span>
                                        <span class="label label-danger"></span>
                                        <i class="fa fa-users pull-right" aria-hidden="true"></i></a>
                                    <div id="group{{ group.id }}" class="sublinks collapse">
                                        {% for student in group.persons.all %}
                                            {% if  student.role == 1 %}
                                                <a class="list-group-item small"
                                                   style="padding-left: 50px; cursor: pointer;"><span
                                                        class="glyphicon glyphicon-user"></span>
                                                    {{ student }}
                                                </a>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                <div class="tab-pane fade" id="E">
                    <table class="table table-hover table-striped table-responsive" id="tasktable">
                        <thead>
                        <tr>
                            <th class="col-md-1">ID</th>
                            <th>Oppgavenavn</th>
                            <th>Kategori</th>
                            <th>Laget av</th>
                            <th>Alternativer</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% if test.randomOrder %}
                            {% for task in test.task_collection.tasks.all %}
                                <tr class="clickable-row"
                                    data-href="#">
                                    <td>
                                        {{ task.id }}
                                    </td>
                                    <td>
                                        {{ task.title }}
                                    </td>
                                    <td>
                                        {% for category in task.category.all %}
                                            {% if forloop.last %}
                                                {{ category }}
                                            {% else %}
                                                {{ category }} -
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ task.author.get_full_name }}
                                    </td>
                                    <td>
                                        <button value="{{ task.id }}" type="button" onclick="previewTask(this)"
                                                class="btn btn-default btn-sm"><span
                                                class="glyphicon glyphicon-eye-open"></span> Forhåndsvis
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            {% for task in test.taskorder_set.all %}
                                <tr class="clickable-row"
                                    data-href="#">
                                    <td>
                                        {{ task.task.id }}
                                    </td>
                                    <td>
                                        {{ task.task.title }}
                                    </td>
                                    <td>
                                        {% for category in task.task.category.all %}
                                            {% if forloop.last %}
                                                {{ category }}
                                            {% else %}
                                                {{ category }} -
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ task.task.author.get_full_name }}
                                    </td>
                                    <td>
                                        <button value="{{ task.task.id }}" type="button" onclick="previewTask(this)"
                                                class="btn btn-default btn-sm"><span
                                                class="glyphicon glyphicon-eye-open"></span> Forhåndsvis
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        <div class="panel-footer">
            <a class="btn btn-primary"><span
                    class="glyphicon glyphicon-plus" aria-hidden="true"></span> Publiser </a>
            <button class="btn btn-primary" data-toggle="modal" data-target="#updateDueDateModal"><i
                    class="fa fa-clock-o" aria-hidden="true"></i>
                Oppdater tidsfrist
            </button>
        </div> <!-- #Panel-footer -->
    </div>
    <form action="" method="post">{% csrf_token %}</form>


    <script>
        $(document).ready(function () {
            var group = $('.list-group-item').not(".small");
            group.each(function (index) {
                var success = 0;
                var danger = 0;
                var id = $(this).data("target");
                var items = $(id).find('.list-group-item');
                items.each(function () {
                    if ($(this).hasClass('list-group-item-success')) {
                        success += 1;
                    } else {
                        danger += 1;
                    }
                });
                $(this).find('.label-info').text(items.length);
                $(this).find('.label-success').text(success);
                $(this).find('.label-danger').text(danger);

            });
        });

        $(function () {
            $("#datepickerUpdateDue").datepicker($.datepicker.regional["no"]);
            $("#datepickerUpdateDue").datepicker("option", "showButtonPanel", true);
            $("#datepickerUpdateDue").datepicker("option", "dateFormat", "DD, d MM, yy");
            $("#datepickerUpdateDue").datepicker("option", "minDate", "0");
        });

        $('.list-group-item').not(".small").on('click', function () {
            var $this = $(this);
            if ($this.hasClass('active')) {
                $('.list-group .active').removeClass('active');
            } else {
                $('.list-group .active').removeClass('active');
                $this.addClass('active');
            }
        });
        $('.list-group-item.small').on('click', function () {
            var $this = $(this);
            $this.addClass('active');
            if ($this.hasClass('success')) {
                bootbox.confirm({
                    size: "medium",
                    title: "Gå til besvarelse?",
                    message: "Do you want to activate the Deathstar now? This cannot be undone.",
                    backdrop: true,
                    buttons: {
                        cancel: {
                            label: '<i class="fa fa-times"></i> Avbryt'
                        },
                        confirm: {
                            label: '<i class="fa fa-check"></i> Gå til svar',
                            className: 'btn-success'
                        }
                    },
                    callback: function (result) {
                        if (result == false) {
                            $this.removeClass('active');
                        }
                    }
                });
            } else {
                bootbox.alert({
                    title: "Advarsel!",
                    message: "Denne brukeren har ikke levert inn noen besvarelse enda!",
                    backdrop: true,
                    callback: function () {
                        $this.removeClass('active');
                    }
                })
            }
        });


        function updateDueDate() {
            var newDueDate = new Date($("#datepickerUpdateDue").datepicker("getDate"));
            var strNewDueDate = newDueDate.getFullYear() + "-" + (newDueDate.getMonth() + 1) + "-" + newDueDate.getDate();
            var newDueTime = $('#timepickerUpdateDue').val();
            var newDueDateAndTime = strNewDueDate + " " + newDueTime;
            $.ajax({
                type: 'POST',
                url: '{% url 'maths:testCreate'  taskCollection_pk=12345%}'.replace(/12345/, {{ test.task_collection.id }}),
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    'id': {{ test.id }},
                    'dueDate': newDueDateAndTime
                },
                dataType: 'json',
                success: function (json) {
                    var date = $('#datepickerUpdateDue').val();
                    $('#id_dueDate').html('<strong>Frist for besvarelse: </strong>' + date + " " + newDueTime);
                    $('#newDate').text('Frist for besvarelse ble oppdatert til ' + date + " " + newDueTime);
                    $('#successDueDate').removeClass('hidden');
                    setTimeout(function () {
                        $('#updateDueDateModal').modal('hide');
                        $('#successDueDate').addClass('hidden');
                    }, 2000);
                },
                error: function (xhr) {
                    alert('error');
                    alert(xhr.responseText);
                }
            });
        }

        /**
         * This function sets up the taskinformation gotten inside a modal from the ajax GET request.
         */
        function previewTask(e) {
            var id = e.value;
            $('#geogebradiv').hide();
            $('#textanswerdiv').hide();
            $('#reasoningdiv').hide();
            $('#multiplechoicediv').hide();
            $.ajax({
                type: 'GET',
                url: '{% url 'maths:taskList' %}',
                data: {
                    'task_id': id
                },
                dataType: 'json',
                success: function (json) {

                    var task = (json);
                    if (task.geogebra_preview != undefined) {
                        $("#previewbilde").attr("src", 'data:image/png;base64,' + (task.geogebra_preview));
                        $('#geogebradiv').show();
                    }
                    document.getElementById('tasktext').innerHTML = (task.task_text);

                    var answertype = (task.task_answertype);
                    if (answertype == 1) {
                        $('#textanswerdiv').show();
                    }

                    if (task.task_reasoning) {
                        $('#reasoningdiv').show();
                    }
                    if (answertype == 2) {
                        var options = (task.options);
                        var div = document.getElementById('optionsdiv');
                        $('#multiplechoicediv').show();
                        div.innerHTML = "";
                        $.each(options, function (index, value) {
                            div.innerHTML += "<input type='radio' name='optionsradio'> " + (value.option) + "<br>";
                        });
                    }
                    $('#previewTaskModal').modal('show');
                },
                error: function (xhr) {
                    alert('error');
                    alert(xhr.responseText);
                }
            });
        }
    </script>
{% endblock %}

{% block modal %}
    <div class="modal fade" id="previewTaskModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" style="width: 95%">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Forhåndsvis oppgave</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6" id="geogebradiv" style="padding-right: 10px;">
                            <img id='previewbilde' alt='' width="100%" style="border:1px solid #021a40;"/>
                        </div>
                        <div class="col-md-6" style="padding-left: 10px">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4><span id="tasktext"></span></h4>
                                </div>
                                <div class="panel-body">
                                    <div id="textanswerdiv">
                                        <label for="answer">Tekstsvar</label>
                                        <textarea class="form-control" id="answer" rows="6" style="resize:vertical"
                                                  placeholder="Skriv svaret ditt her..."></textarea>
                                    </div>

                                    <div id="multiplechoicediv">
                                        <label for="reasoning">Svaralternativer</label>
                                        <div id="optionsdiv">

                                        </div>
                                    </div>

                                    <div id="reasoningdiv">
                                        <label for="reasoning">Begrunnelse</label>
                                        <textarea class="form-control" id="reasoning" rows="6" style="resize:vertical"
                                                  placeholder="Begrunn svaret ditt..."></textarea>
                                    </div>

                                </div>
                                <div class="panel-footer">
                                    <button type="button" class="btn btn-success">Svar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Lukk</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="updateDueDateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Oppdater tidsfrist</h4>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input id="datepickerUpdateDue" type="text" class="form-control"
                               placeholder="Velg ny dato for leveringsfrist"
                               aria-describedby="basic-addon1"
                               style="position: relative; z-index: 9999;">
                        <span class="input-group-addon" id="basic-addon1"><i
                                class="fa fa-calendar" aria-hidden="true"></i></span>
                    </div>
                    <div class="input-group clockpicker" style="margin-top: 10px;">
                        <input id="timepickerUpdateDue" class="form-control"
                               placeholder="Velg nytt klokkeslett for leveringsfrist"
                               aria-describedby="basic-addon1" style="position: relative; z-index: 9999 !important;">
                        <span class="input-group-addon" id="basic-addon1"><i
                                class="fa fa-clock-o" aria-hidden="true"></i></span>
                    </div>
                    <div id="successDueDate" class="alert alert-success hidden" style="margin-top: 10px">
                        <strong>Fullført!</strong> <h5 id="newDate"></h5>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="updateDueDate()">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i> Oppdater
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Lukk</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('.clockpicker').clockpicker({
            autoclose: true
        });
    </script>
{% endblock %}